<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Realtime Chat</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: #f7f7f9;
            color: #222;
            padding: 24px;
        }

        .chat {
            max-width: 720px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        #messages {
            list-style: none;
            padding: 0;
            margin: 12px 0;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        #messages li {
            padding: 6px 8px;
            border-bottom: 1px dashed #f0f0f0;
        }

        #messages li.own {
            color: #c0392b;
            /* red for own messages */
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        input[type="text"],
        input#msg,
        #username {
            padding: 6px 8px;
            border: 1px solid #d1d5da;
            border-radius: 4px;
        }

        button {
            padding: 6px 10px;
            border: 1px solid #d1d5da;
            background: #fafbfc;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #f0f3f5
        }

        .meta {
            color: #666;
            font-size: 0.9em;
            margin-left: 8px
        }
    </style>
</head>

<body>
    <div class="chat">
        <h3>Chat App</h3>
        <div>
            <label for="username">Name:</label>
            <input id="username" placeholder="Enter name (optional)" />
            <span id="currentName">(noname)</span>
        </div>
        <ul id="messages"></ul>
        <div class="controls">
            <input id="msg" placeholder="Nháº­p tin nháº¯n..." style="flex:1" />
            <button onclick="send()">Gá»­i</button>
            <button onclick="reloadMessages()">Reload</button>
        </div>
    </div>

    <script>
        // ðŸ”¹ Tá»± Ä‘á»™ng táº¡o Ä‘á»‹a chá»‰ WebSocket Ä‘Ãºng theo domain hiá»‡n táº¡i
const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
const wsHost = window.location.host;
const ws = new WebSocket(protocol + wsHost + '/ws');


        // update current name display when user types
        const nameInput = document.getElementById('username');
        const currentNameSpan = document.getElementById('currentName');
        nameInput.addEventListener('input', () => {
            const v = nameInput.value.trim() || 'noname';
            currentNameSpan.textContent = `(${v})`;
        });

        // helper to render a message item. If sender matches current name -> red color
        function renderMessage(msg) {
            const li = document.createElement('li');
            if (typeof msg === 'string') {
                li.textContent = msg;
            } else if (msg && msg.sender !== undefined && msg.content !== undefined) {
                li.textContent = `${msg.sender}: ${msg.content}`;
                const cur = nameInput.value.trim() || 'noname';
                if (msg.sender === cur) {
                    li.classList.add('own');
                }
            } else {
                li.textContent = String(msg);
            }
            document.getElementById('messages').appendChild(li);
        }

        ws.onmessage = (e) => {
            // try parse as JSON Message, fallback to raw text
            try {
                const parsed = JSON.parse(e.data);
                renderMessage(parsed);
            } catch (err) {
                renderMessage(e.data);
            }
        };

        function send() {
            const m = document.getElementById('msg').value;
            const sender = nameInput.value.trim() || 'noname';
            const payload = JSON.stringify({ sender: sender, content: m });
            ws.send(payload);
            document.getElementById('msg').value = '';
        }

        // Fetch all messages from server and repopulate the list
        async function reloadMessages() {
            try {
                const res = await fetch('/messages');
                if (!res.ok) throw new Error('Network response was not ok');
                const msgs = await res.json();
                const list = document.getElementById('messages');
                list.innerHTML = '';
                msgs.forEach(m => {
                    renderMessage(m);
                });
            } catch (err) {
                console.error('Failed to reload messages:', err);
            }
        }
    </script>
</body>

</html>